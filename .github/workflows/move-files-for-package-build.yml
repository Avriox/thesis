name: R Package Auto-Build

on:
  push:
    branches:
      - package_v2

jobs:
  build-r-package:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3
      with:
        fetch-depth: 0  # Fetch all history for all branches
    
    - name: Setup Git Identity
      run: |
        git config --global user.name "GitHub Action"
        git config --global user.email "action@github.com"
    
    - name: Create or Reset r-package-build Branch
      run: |
        # Check if r-package-build branch exists
        if git ls-remote --heads origin r-package-build | grep r-package-build; then
          echo "Branch exists, resetting"
          git checkout package_v2
          git branch -D r-package-build || true
          git checkout -b r-package-build
        else
          echo "Branch doesn't exist, creating"
          git checkout -b r-package-build
        fi
    
    - name: Restructure Files for R Package
      run: |
        # Create necessary directories if they don't exist
        mkdir -p src
        
        # Copy mombf source files to src/
        echo "Copying mombf files"
        cp -v mombf/mombf/src/*.cpp src/ || true
        cp -v mombf/mombf/src/*.h src/ || true
        
        # Copy lasso library files to src/
        echo "Copying lasso files"
        cp -v lib/lasso/*.cpp src/ || true
        cp -v lib/lasso/*.h src/ || true
        
        # List all files in src/ to verify
        echo "Files in src/ directory:"
        ls -la src/
    
    - name: Check for Modified Files
      id: check_modified
      run: |
        git status --porcelain
        if [[ -n $(git status --porcelain) ]]; then
          echo "modified=true" >> $GITHUB_OUTPUT
        else
          echo "modified=false" >> $GITHUB_OUTPUT
        fi
    
    - name: Commit and Push Changes
      if: steps.check_modified.outputs.modified == 'true'
      run: |
        git add .
        git commit -m "Auto-update R package structure [skip ci]"
        git push -f origin r-package-build
        echo "Successfully pushed to r-package-build branch"